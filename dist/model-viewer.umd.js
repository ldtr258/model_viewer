(function(R,n){typeof exports=="object"&&typeof module<"u"?n(exports,require("three"),require("@bridge-editor/molang"),require("wintersky")):typeof define=="function"&&define.amd?define(["exports","three","@bridge-editor/molang","wintersky"],n):(R=typeof globalThis<"u"?globalThis:R||self,n(R.ModelViewer={},R.three,R.molang,R.Wintersky))})(this,function(R,n,me,fe){"use strict";const q={type:"change"},D={type:"start"},K={type:"end"};class ge extends n.EventDispatcher{constructor(i,o){super(),this.object=i,this.domElement=o,this.domElement.style.touchAction="none",this.enabled=!0,this.target=new n.Vector3,this.minDistance=0,this.maxDistance=1/0,this.minZoom=0,this.maxZoom=1/0,this.minPolarAngle=0,this.maxPolarAngle=Math.PI,this.minAzimuthAngle=-1/0,this.maxAzimuthAngle=1/0,this.enableDamping=!1,this.dampingFactor=.05,this.enableZoom=!0,this.zoomSpeed=1,this.enableRotate=!0,this.rotateSpeed=1,this.enablePan=!0,this.panSpeed=1,this.screenSpacePanning=!0,this.keyPanSpeed=7,this.autoRotate=!1,this.autoRotateSpeed=2,this.keys={LEFT:"ArrowLeft",UP:"ArrowUp",RIGHT:"ArrowRight",BOTTOM:"ArrowDown"},this.mouseButtons={LEFT:n.MOUSE.ROTATE,MIDDLE:n.MOUSE.DOLLY,RIGHT:n.MOUSE.PAN},this.touches={ONE:n.TOUCH.ROTATE,TWO:n.TOUCH.DOLLY_PAN},this.target0=this.target.clone(),this.position0=this.object.position.clone(),this.zoom0=this.object.zoom,this._domElementKeyEvents=null,this.getPolarAngle=function(){return r.phi},this.getAzimuthalAngle=function(){return r.theta},this.getDistance=function(){return this.object.position.distanceTo(this.target)},this.listenToKeyEvents=function(t){t.addEventListener("keydown",le),this._domElementKeyEvents=t},this.saveState=function(){e.target0.copy(e.target),e.position0.copy(e.object.position),e.zoom0=e.object.zoom},this.reset=function(){e.target.copy(e.target0),e.object.position.copy(e.position0),e.object.zoom=e.zoom0,e.object.updateProjectionMatrix(),e.dispatchEvent(q),e.update(),a=s.NONE},this.update=function(){const t=new n.Vector3,c=new n.Quaternion().setFromUnitVectors(i.up,new n.Vector3(0,1,0)),T=c.clone().invert(),M=new n.Vector3,v=new n.Quaternion,Y=2*Math.PI;return function(){const pe=e.object.position;t.copy(pe).sub(e.target),t.applyQuaternion(c),r.setFromVector3(t),e.autoRotate&&a===s.NONE&&P(j()),e.enableDamping?(r.theta+=h.theta*e.dampingFactor,r.phi+=h.phi*e.dampingFactor):(r.theta+=h.theta,r.phi+=h.phi);let N=e.minAzimuthAngle,U=e.maxAzimuthAngle;return isFinite(N)&&isFinite(U)&&(N<-Math.PI?N+=Y:N>Math.PI&&(N-=Y),U<-Math.PI?U+=Y:U>Math.PI&&(U-=Y),N<=U?r.theta=Math.max(N,Math.min(U,r.theta)):r.theta=r.theta>(N+U)/2?Math.max(N,r.theta):Math.min(U,r.theta)),r.phi=Math.max(e.minPolarAngle,Math.min(e.maxPolarAngle,r.phi)),r.makeSafe(),r.radius*=u,r.radius=Math.max(e.minDistance,Math.min(e.maxDistance,r.radius)),e.enableDamping===!0?e.target.addScaledVector(y,e.dampingFactor):e.target.add(y),t.setFromSpherical(r),t.applyQuaternion(T),pe.copy(e.target).add(t),e.object.lookAt(e.target),e.enableDamping===!0?(h.theta*=1-e.dampingFactor,h.phi*=1-e.dampingFactor,y.multiplyScalar(1-e.dampingFactor)):(h.set(0,0,0),y.set(0,0,0)),u=1,l||M.distanceToSquared(e.object.position)>g||8*(1-v.dot(e.object.quaternion))>g?(e.dispatchEvent(q),M.copy(e.object.position),v.copy(e.object.quaternion),l=!1,!0):!1}}(),this.dispose=function(){e.domElement.removeEventListener("contextmenu",ue),e.domElement.removeEventListener("pointerdown",ae),e.domElement.removeEventListener("pointercancel",re),e.domElement.removeEventListener("wheel",ce),e.domElement.removeEventListener("pointermove",B),e.domElement.removeEventListener("pointerup",X),e._domElementKeyEvents!==null&&e._domElementKeyEvents.removeEventListener("keydown",le)};const e=this,s={NONE:-1,ROTATE:0,DOLLY:1,PAN:2,TOUCH_ROTATE:3,TOUCH_PAN:4,TOUCH_DOLLY_PAN:5,TOUCH_DOLLY_ROTATE:6};let a=s.NONE;const g=1e-6,r=new n.Spherical,h=new n.Spherical;let u=1;const y=new n.Vector3;let l=!1;const m=new n.Vector2,b=new n.Vector2,E=new n.Vector2,A=new n.Vector2,p=new n.Vector2,w=new n.Vector2,f=new n.Vector2,x=new n.Vector2,S=new n.Vector2,d=[],I={};function j(){return 2*Math.PI/60/60*e.autoRotateSpeed}function O(){return Math.pow(.95,e.zoomSpeed)}function P(t){h.theta-=t}function _(t){h.phi-=t}const V=function(){const t=new n.Vector3;return function(T,M){t.setFromMatrixColumn(M,0),t.multiplyScalar(-T),y.add(t)}}(),F=function(){const t=new n.Vector3;return function(T,M){e.screenSpacePanning===!0?t.setFromMatrixColumn(M,1):(t.setFromMatrixColumn(M,0),t.crossVectors(e.object.up,t)),t.multiplyScalar(T),y.add(t)}}(),k=function(){const t=new n.Vector3;return function(T,M){const v=e.domElement;if(e.object.isPerspectiveCamera){const Y=e.object.position;t.copy(Y).sub(e.target);let H=t.length();H*=Math.tan(e.object.fov/2*Math.PI/180),V(2*T*H/v.clientHeight,e.object.matrix),F(2*M*H/v.clientHeight,e.object.matrix)}else e.object.isOrthographicCamera?(V(T*(e.object.right-e.object.left)/e.object.zoom/v.clientWidth,e.object.matrix),F(M*(e.object.top-e.object.bottom)/e.object.zoom/v.clientHeight,e.object.matrix)):(console.warn("WARNING: OrbitControls.js encountered an unknown camera type - pan disabled."),e.enablePan=!1)}}();function G(t){e.object.isPerspectiveCamera?u/=t:e.object.isOrthographicCamera?(e.object.zoom=Math.max(e.minZoom,Math.min(e.maxZoom,e.object.zoom*t)),e.object.updateProjectionMatrix(),l=!0):(console.warn("WARNING: OrbitControls.js encountered an unknown camera type - dolly/zoom disabled."),e.enableZoom=!1)}function $(t){e.object.isPerspectiveCamera?u*=t:e.object.isOrthographicCamera?(e.object.zoom=Math.max(e.minZoom,Math.min(e.maxZoom,e.object.zoom/t)),e.object.updateProjectionMatrix(),l=!0):(console.warn("WARNING: OrbitControls.js encountered an unknown camera type - dolly/zoom disabled."),e.enableZoom=!1)}function Q(t){m.set(t.clientX,t.clientY)}function xe(t){f.set(t.clientX,t.clientY)}function J(t){A.set(t.clientX,t.clientY)}function Oe(t){b.set(t.clientX,t.clientY),E.subVectors(b,m).multiplyScalar(e.rotateSpeed);const c=e.domElement;P(2*Math.PI*E.x/c.clientHeight),_(2*Math.PI*E.y/c.clientHeight),m.copy(b),e.update()}function ke(t){x.set(t.clientX,t.clientY),S.subVectors(x,f),S.y>0?G(O()):S.y<0&&$(O()),f.copy(x),e.update()}function ve(t){p.set(t.clientX,t.clientY),w.subVectors(p,A).multiplyScalar(e.panSpeed),k(w.x,w.y),A.copy(p),e.update()}function Re(t){t.deltaY<0?$(O()):t.deltaY>0&&G(O()),e.update()}function Se(t){let c=!1;switch(t.code){case e.keys.UP:t.ctrlKey||t.metaKey||t.shiftKey?_(2*Math.PI*e.rotateSpeed/e.domElement.clientHeight):k(0,e.keyPanSpeed),c=!0;break;case e.keys.BOTTOM:t.ctrlKey||t.metaKey||t.shiftKey?_(-2*Math.PI*e.rotateSpeed/e.domElement.clientHeight):k(0,-e.keyPanSpeed),c=!0;break;case e.keys.LEFT:t.ctrlKey||t.metaKey||t.shiftKey?P(2*Math.PI*e.rotateSpeed/e.domElement.clientHeight):k(e.keyPanSpeed,0),c=!0;break;case e.keys.RIGHT:t.ctrlKey||t.metaKey||t.shiftKey?P(-2*Math.PI*e.rotateSpeed/e.domElement.clientHeight):k(-e.keyPanSpeed,0),c=!0;break}c&&(t.preventDefault(),e.update())}function ee(){if(d.length===1)m.set(d[0].pageX,d[0].pageY);else{const t=.5*(d[0].pageX+d[1].pageX),c=.5*(d[0].pageY+d[1].pageY);m.set(t,c)}}function te(){if(d.length===1)A.set(d[0].pageX,d[0].pageY);else{const t=.5*(d[0].pageX+d[1].pageX),c=.5*(d[0].pageY+d[1].pageY);A.set(t,c)}}function ie(){const t=d[0].pageX-d[1].pageX,c=d[0].pageY-d[1].pageY,T=Math.sqrt(t*t+c*c);f.set(0,T)}function Le(){e.enableZoom&&ie(),e.enablePan&&te()}function Ne(){e.enableZoom&&ie(),e.enableRotate&&ee()}function oe(t){if(d.length==1)b.set(t.pageX,t.pageY);else{const T=Z(t),M=.5*(t.pageX+T.x),v=.5*(t.pageY+T.y);b.set(M,v)}E.subVectors(b,m).multiplyScalar(e.rotateSpeed);const c=e.domElement;P(2*Math.PI*E.x/c.clientHeight),_(2*Math.PI*E.y/c.clientHeight),m.copy(b)}function ne(t){if(d.length===1)p.set(t.pageX,t.pageY);else{const c=Z(t),T=.5*(t.pageX+c.x),M=.5*(t.pageY+c.y);p.set(T,M)}w.subVectors(p,A).multiplyScalar(e.panSpeed),k(w.x,w.y),A.copy(p)}function se(t){const c=Z(t),T=t.pageX-c.x,M=t.pageY-c.y,v=Math.sqrt(T*T+M*M);x.set(0,v),S.set(0,Math.pow(x.y/f.y,e.zoomSpeed)),G(S.y),f.copy(x)}function Ue(t){e.enableZoom&&se(t),e.enablePan&&ne(t)}function je(t){e.enableZoom&&se(t),e.enableRotate&&oe(t)}function ae(t){e.enabled!==!1&&(d.length===0&&(e.domElement.setPointerCapture(t.pointerId),e.domElement.addEventListener("pointermove",B),e.domElement.addEventListener("pointerup",X)),Ve(t),t.pointerType==="touch"?Ye(t):Ie(t))}function B(t){e.enabled!==!1&&(t.pointerType==="touch"?ze(t):_e(t))}function X(t){he(t),d.length===0&&(e.domElement.releasePointerCapture(t.pointerId),e.domElement.removeEventListener("pointermove",B),e.domElement.removeEventListener("pointerup",X)),e.dispatchEvent(K),a=s.NONE}function re(t){he(t)}function Ie(t){let c;switch(t.button){case 0:c=e.mouseButtons.LEFT;break;case 1:c=e.mouseButtons.MIDDLE;break;case 2:c=e.mouseButtons.RIGHT;break;default:c=-1}switch(c){case n.MOUSE.DOLLY:if(e.enableZoom===!1)return;xe(t),a=s.DOLLY;break;case n.MOUSE.ROTATE:if(t.ctrlKey||t.metaKey||t.shiftKey){if(e.enablePan===!1)return;J(t),a=s.PAN}else{if(e.enableRotate===!1)return;Q(t),a=s.ROTATE}break;case n.MOUSE.PAN:if(t.ctrlKey||t.metaKey||t.shiftKey){if(e.enableRotate===!1)return;Q(t),a=s.ROTATE}else{if(e.enablePan===!1)return;J(t),a=s.PAN}break;default:a=s.NONE}a!==s.NONE&&e.dispatchEvent(D)}function _e(t){switch(a){case s.ROTATE:if(e.enableRotate===!1)return;Oe(t);break;case s.DOLLY:if(e.enableZoom===!1)return;ke(t);break;case s.PAN:if(e.enablePan===!1)return;ve(t);break}}function ce(t){e.enabled===!1||e.enableZoom===!1||a!==s.NONE||(t.preventDefault(),e.dispatchEvent(D),Re(t),e.dispatchEvent(K))}function le(t){e.enabled===!1||e.enablePan===!1||Se(t)}function Ye(t){switch(de(t),d.length){case 1:switch(e.touches.ONE){case n.TOUCH.ROTATE:if(e.enableRotate===!1)return;ee(),a=s.TOUCH_ROTATE;break;case n.TOUCH.PAN:if(e.enablePan===!1)return;te(),a=s.TOUCH_PAN;break;default:a=s.NONE}break;case 2:switch(e.touches.TWO){case n.TOUCH.DOLLY_PAN:if(e.enableZoom===!1&&e.enablePan===!1)return;Le(),a=s.TOUCH_DOLLY_PAN;break;case n.TOUCH.DOLLY_ROTATE:if(e.enableZoom===!1&&e.enableRotate===!1)return;Ne(),a=s.TOUCH_DOLLY_ROTATE;break;default:a=s.NONE}break;default:a=s.NONE}a!==s.NONE&&e.dispatchEvent(D)}function ze(t){switch(de(t),a){case s.TOUCH_ROTATE:if(e.enableRotate===!1)return;oe(t),e.update();break;case s.TOUCH_PAN:if(e.enablePan===!1)return;ne(t),e.update();break;case s.TOUCH_DOLLY_PAN:if(e.enableZoom===!1&&e.enablePan===!1)return;Ue(t),e.update();break;case s.TOUCH_DOLLY_ROTATE:if(e.enableZoom===!1&&e.enableRotate===!1)return;je(t),e.update();break;default:a=s.NONE}}function ue(t){e.enabled!==!1&&t.preventDefault()}function Ve(t){d.push(t)}function he(t){delete I[t.pointerId];for(let c=0;c<d.length;c++)if(d[c].pointerId==t.pointerId){d.splice(c,1);return}}function de(t){let c=I[t.pointerId];c===void 0&&(c=new n.Vector2,I[t.pointerId]=c),c.set(t.pageX,t.pageY)}function Z(t){const c=t.pointerId===d[0].pointerId?d[1]:d[0];return I[c.pointerId]}e.domElement.addEventListener("contextmenu",ue),e.domElement.addEventListener("pointerdown",ae),e.domElement.addEventListener("pointercancel",re),e.domElement.addEventListener("wheel",ce,{passive:!1}),this.update()}}class C{constructor(i,o){this.animation=i,this.currentEffectIndex=0,this.tickingEffects=[],this.effects=Object.entries(o).map(([e,s])=>[Number(e),Array.isArray(s)?s:[s]]).sort(([e],[s])=>e-s)}getCurrentEffects(){if(this.currentEffectIndex>=this.effects.length)return;const i=this.effects[this.currentEffectIndex];if(!(i[0]>this.animation.roundedCurrentTime))return this.currentEffectIndex++,i[1]}reset(){this.currentEffectIndex=0}}class ye extends C{tick(){const i=super.getCurrentEffects()??[];i.length>0&&console.log(`Playing sound effects: "${i.map(o=>o.effect).join(", ")}"`)}}class be extends C{constructor(){super(...arguments),this.disposables=[]}tick(){this.tickingEffects.forEach(o=>o.tick());const i=super.getCurrentEffects()??[];for(const{locator:o,effect:e,pre_effect_script:s}of i){if(!e)return;const a=this.animation.getAnimator(),g=a.getModel(),r=a.getEmitter(e);if(!r||!a.winterskyScene)return;const h=o?g.getLocator(o):void 0,u=new fe.Emitter(a.winterskyScene,r,{parent_mode:h?"locator":"entity",loop_mode:"once"});h&&(h.add(u.local_space),u.local_space.parent=h);const y={tick:()=>{u.tick(),u.enabled||(u.delete(),this.tickingEffects=this.tickingEffects.filter(l=>l!==y))}};this.tickingEffects.push(y),this.disposables.push({dispose:()=>{u.delete(),this.tickingEffects=this.tickingEffects.filter(l=>l!==y)}}),u.start(),u.tick()}}dispose(){this.disposables.forEach(i=>i.dispose()),this.disposables=[]}}class we{constructor(i,o){this.animator=i,this.animationData=o,this.startTimestamp=0,this.lastFrameTimestamp=0,this.isRunning=!1,this.env={"query.anim_time":()=>this.currentTime,"query.delta_time":()=>this.startTimestamp-this.lastFrameTimestamp,"query.life_time":()=>this.currentTime},this.molang=new me.Molang(this.env,{convertUndefined:!0}),this.soundEffects=new ye(this,this.animationData.sound_effects??{}),this.particleEffects=new be(this,this.animationData.particle_effects??{})}getAnimator(){return this.animator}execute(i){return this.molang.executeAndCatch(i)}parseBoneModifier(i){if(typeof i=="number")return[i,i,i];if(typeof i=="string"){const o=typeof i=="string"?this.execute(i):i;return[o,o,o]}else{if(Array.isArray(i))return i.map(o=>typeof o=="string"?this.execute(o):o);if(i!==void 0){const o=Object.entries(i).map(([e,s])=>[Number(e),s]).sort(([e],[s])=>e-s);for(let e=o.length-1;e>=0;e--){let[s,a]=o[e];if(!(s>this.currentTime))if(s===this.currentTime){if(Array.isArray(a))return a.map(g=>typeof g=="string"?this.execute(g):g);throw new Error("Format not supported yet")}else{let[g,r]=o[n.MathUtils.euclideanModulo(e+1,o.length)],h=g-s;if(Array.isArray(a)&&Array.isArray(r))return a=a.map(u=>typeof u=="string"?this.execute(u):u),r=r.map(u=>typeof u=="string"?this.execute(u):u),a.map((u,y)=>u+(r[y]-u)/h*(this.currentTime-s));throw new Error("Format not supported yet")}}return[0,0,0]}}}tick(){this.soundEffects.tick(),this.particleEffects.tick();const i=this.animator.getModel().getBoneMap();for(let o in this.animationData.bones){const e=i.get(o);if(!e)continue;const{position:s,rotation:a,scale:g}=this.animationData.bones[o],[r,h,u]=[s,a,g].map(y=>this.parseBoneModifier(y));if(r){const y=e.position.toArray();e.position.set(...r.map((l,m)=>(m===0?-1:1)*l+y[m]))}if(h){const y=e.rotation.toArray();e.rotation.set(...h.map(l=>n.MathUtils.degToRad(l)).map((l,m)=>y[m]+(m===2?l:-l)))}u&&e.scale.set(...u)}this.currentTime>this.animationData.animation_length&&(this.animationData.loop?this.loop():this.pause()),this.lastFrameTimestamp=Date.now()}play(){this.isRunning=!0,this.startTimestamp=Date.now()}pause(){this.isRunning=!1}loop(){this.startTimestamp=Date.now(),this.soundEffects.reset(),this.particleEffects.reset()}dispose(){this.particleEffects.dispose()}get currentTime(){return(Date.now()-this.startTimestamp)/1e3}get roundedCurrentTime(){return Math.round((Date.now()-this.startTimestamp)/50)/20}get shouldTick(){return this.isRunning}}class Ee{constructor(i){this.model=i,this.animations=new Map,this.particleEmitters=new Map}setupDefaultBonePoses(){for(let i of this.model.getBoneMap().values())i.userData.defaultRotation=i.rotation.toArray(),i.userData.defaultPosition=i.position.toArray()}dispose(){this.disposeAnimations();for(let i of this.model.getBoneMap().values())delete i.userData.defaultRotation,delete i.userData.defaultPosition}disposeAnimations(){this.animations.forEach(i=>i.dispose())}setupWintersky(i){this.winterskyScene=i}addAnimation(i,o){this.animations.set(i,new we(this,o))}addEmitter(i,o){this.particleEmitters.set(i,o)}getEmitter(i){return this.particleEmitters.get(i)}play(i){const o=this.animations.get(i);if(!o)throw new Error(`Unknown animation: "${i}"`);o.play()}pause(i){const o=this.animations.get(i);if(!o)throw new Error(`Unknown animation: "${i}"`);o.pause()}pauseAll(){for(const i of this.animations.values())i.pause()}tick(){for(let i of this.model.getBoneMap().values())i.rotation.set(...i.userData.defaultRotation),i.position.set(...i.userData.defaultPosition);this.animations.forEach(i=>i.shouldTick&&i.tick())}get shouldTick(){return[...this.animations.values()].some(i=>i.shouldTick)}getModel(){return this.model}}const Te=[{name:"west",baseUV:[2,1],dir:[-1,0,0],corners:[{pos:[-.5,1,0],uv:[0,1]},{pos:[-.5,0,0],uv:[0,0]},{pos:[-.5,1,1],uv:[1,1]},{pos:[-.5,0,1],uv:[1,0]}]},{name:"east",baseUV:[0,1],dir:[1,0,0],corners:[{pos:[.5,1,1],uv:[0,1]},{pos:[.5,0,1],uv:[0,0]},{pos:[.5,1,0],uv:[1,1]},{pos:[.5,0,0],uv:[1,0]}]},{name:"down",baseUV:[2,0],dir:[0,-1,0],corners:[{pos:[.5,0,1],uv:[0,1]},{pos:[-.5,0,1],uv:[1,1]},{pos:[.5,0,0],uv:[0,0]},{pos:[-.5,0,0],uv:[1,0]}]},{name:"up",baseUV:[1,0],dir:[0,1,0],corners:[{pos:[-.5,1,1],uv:[1,1]},{pos:[.5,1,1],uv:[0,1]},{pos:[-.5,1,0],uv:[1,0]},{pos:[.5,1,0],uv:[0,0]}]},{name:"north",baseUV:[1,1],dir:[0,0,-1],corners:[{pos:[-.5,0,0],uv:[1,0]},{pos:[.5,0,0],uv:[0,0]},{pos:[-.5,1,0],uv:[1,1]},{pos:[.5,1,0],uv:[0,1]}]},{name:"south",baseUV:[3,1],dir:[0,0,1],corners:[{pos:[-.5,0,1],uv:[0,0]},{pos:[.5,0,1],uv:[1,0]},{pos:[-.5,1,1],uv:[0,1]},{pos:[.5,1,1],uv:[1,1]}]}],z=.03;class Me{constructor(i){var p,w;this.positions=[],this.indices=[],this.normals=[],this.uvs=[],this.geometry=new n.BufferGeometry,this.group=new n.Group;const{textureSize:[o,e],textureDiscrepancyFactor:[s,a],mirror:g,width:r,height:h,depth:u}=i,[y,l]=[o*s,e*a],m=i.startUV??[0,0],b=!Array.isArray(m);let E=0,A=0;b||([E,A]=m);for(let{name:f,dir:x,corners:S,baseUV:[d,I]}of Te){const j=this.positions.length/3;let O,P;if(b){if(m[f]===void 0)continue;[E,A]=((p=m[f])==null?void 0:p.uv)||[],[O,P]=((w=m[f])==null?void 0:w.uv_size)||[],O*=s,P*=a,E*=s,A*=a,d=0,I=0}for(const{pos:[_,V,F],uv:k}of S)this.positions.push((g?-_:_)*r,V*h,F*u),this.normals.push(...x),this.uvs.push((E+(+(d>0)+ +(d>2))*Math.floor(O??u)+ +(d>1)*Math.floor(O??r)+k[0]*Math.floor(f==="west"||f==="east"?O??u:O??r)+(k[0]===0?z:-z))/(y/(b?1:s)),1-(A+I*Math.floor(P??u)+Math.floor(f==="up"||f==="down"?P??u:P??h)-k[1]*Math.floor(f==="up"||f==="down"?P??u:P??h)+(k[1]===0?-z:z))/(l/(b?1:a)));this.indices.push(j,j+1,j+2,j+2,j+1,j+3)}this.createGeometry(),this.createMesh(i)}createGeometry(){this.geometry.setAttribute("position",new n.BufferAttribute(new Float32Array(this.positions),3)),this.geometry.setAttribute("normal",new n.BufferAttribute(new Float32Array(this.normals),3)),this.geometry.setAttribute("uv",new n.BufferAttribute(new Float32Array(this.uvs),2)),this.geometry.setIndex(this.indices)}createMesh({material:i,width:o,height:e,depth:s,pivot:a,rotation:g,origin:r,inflate:h=0}){const u=h*2+o,y=new n.Mesh(this.geometry,i);if(this.group.rotation.order="ZYX",a===void 0&&(a=[u/2,e/2,s/2]),this.group.add(y),g){this.group.position.set(-a[0],a[1],a[2]),y.position.set(-r[0]-u/2+a[0]+h,r[1]-a[1]-h,r[2]-a[2]-h);const[l,m,b]=g;this.group.rotation.set(n.MathUtils.degToRad(-l),n.MathUtils.degToRad(-m),n.MathUtils.degToRad(b))}else this.group.position.set(-r[0]-u/2+h,r[1]-h,r[2]-h);h&&this.group.scale.set(o!==0?1+h/(o/2):1,e!==0?1+h/(e/2):1,s!==0?1+h/(s/2):1)}getGroup(){return this.group}}class Ae{constructor(i){var e,s,a,g;if(this.positions=[],this.indices=[],this.normals=[],this.uvs=[],this.geometry=new n.BufferGeometry,this.group=new n.Group,!Array.isArray(i.polys))throw new Error("Format not supported yet!");i.normalized_uvs||(i.uvs=(e=i==null?void 0:i.uvs)==null?void 0:e.map(([r,h])=>[r/i.textureSize[0],h/i.textureSize[1]]));let o=0;for(const r of i.polys){for(const[h,u,y]of r)this.positions.push(...((s=i==null?void 0:i.positions)==null?void 0:s[h])??[]),this.normals.push(...((a=i==null?void 0:i.normals)==null?void 0:a[u])??[]),this.uvs.push(...((g=i==null?void 0:i.uvs)==null?void 0:g[y])??[]);r.length===3?this.indices.push(o,o+1,o+2):this.indices.push(o+2,o+1,o,o+2,o,o+3),o+=r.length}this.createGeometry(),this.createMesh(i)}createGeometry(){this.geometry.setAttribute("position",new n.BufferAttribute(new Float32Array(this.positions),3)),this.geometry.setAttribute("normal",new n.BufferAttribute(new Float32Array(this.normals),3)),this.geometry.setAttribute("uv",new n.BufferAttribute(new Float32Array(this.uvs),2)),this.geometry.setIndex(this.indices)}createMesh({material:i}){const o=new n.Mesh(this.geometry,i);this.group.add(o)}getGroup(){return this.group}}class W{constructor(i,o){var s;this.modelData=i,this.texturePath=o,this.boneMap=new Map,this.locators=new Map,this.animator=new Ee(this);const e=((s=i==null?void 0:i.description)==null?void 0:s.identifier)??"geometry.unknown";this.model=new n.Group,this.model.name=e}async create(){var r,h,u,y;const i=this.modelData,o=await this.loadTexture(this.texturePath),e=[((r=i==null?void 0:i.description)==null?void 0:r.texture_width)??o.image.width,((h=i==null?void 0:i.description)==null?void 0:h.texture_height)??o.image.height],s=[o.image.width/e[0],o.image.height/e[1]],a=new Map;o.magFilter=n.NearestFilter,o.minFilter=n.NearestFilter;const g=new n.MeshLambertMaterial({side:n.DoubleSide,alphaTest:.2,transparent:!0,map:o});(u=i==null?void 0:i.bones)==null||u.forEach(l=>{var A;const m=new n.Group;if(m.name=l.name??"unknown",l.poly_mesh){const p=new Ae({...l.poly_mesh,textureSize:e,material:g,mirror:l.mirror??!1,origin:[0,0,0],inflate:l.inflate,rotation:[0,0,0],pivot:l.pivot}).getGroup();p.name=`#bone.${l.name}#polyMesh`,m.add(p)}(A=l.cubes)==null||A.forEach((p,w)=>{var x,S,d;const f=new Me({width:((x=p.size)==null?void 0:x[0])??0,height:((S=p.size)==null?void 0:S[1])??0,depth:((d=p.size)==null?void 0:d[2])??0,startUV:p.uv,textureSize:e,textureDiscrepancyFactor:s,material:g,mirror:p.mirror===void 0&&p.rotation===void 0?l.mirror??!1:p.mirror??!1,origin:p.origin??[0,0,0],inflate:p.inflate??l.inflate,rotation:p.rotation,pivot:p.pivot??l.pivot}).getGroup();f.name=`#bone.${l.name}#cube.${w}`,m.add(f)});const b=new n.Group;if(b.rotation.order="ZYX",l.pivot){const[p,w,f]=l.pivot;b.position.set(-p,w,f),m.position.set(p,-w,-f)}else b.position.set(0,0,0);if(b.add(m),b.name=`#pivot.${l.name}`,l.rotation){const[p,w,f]=l.rotation;b.rotation.set(n.MathUtils.degToRad(-p),n.MathUtils.degToRad(-w),n.MathUtils.degToRad(f))}const E=l.locators??{};for(const p in E){const w=new n.Group;w.name=`locator#${p}`;const f=E[p];Array.isArray(f)?w.position.set(...f):typeof f=="object"&&(w.position.set(...f.offset??[0,0,0]),w.rotation.set(...f.rotation??[0,0,0])),this.locators.set(p,w),b.add(w)}l.parent||this.model.add(b),l.name&&(a.set(l.name,[l.parent,b]),this.boneMap.set(l.name,b))});for(let[l,[m,b]]of a)if(m){const E=(y=a.get(m))==null?void 0:y[1];E&&E.name.startsWith("#pivot.")?E.children[0].add(b):E&&E.add(b)}this.animator.setupDefaultBonePoses()}getGroup(){return this.model}getBoneMap(){return this.boneMap}getLocator(i){return this.locators.get(i)}tick(){this.animator.tick()}get shouldTick(){return this.animator.shouldTick}createOutlineBox(i,o,e){const s=new n.LineBasicMaterial({side:n.DoubleSide,color:i,linewidth:20}),a=new n.BoxGeometry(e.x,e.y,e.z),g=new n.EdgesGeometry(a),r=new n.LineSegments(g,s);return r.position.set(o.x,o.y+e.y/2,o.z),r.name="helperBox",this.model.add(r),{dispose:()=>{this.model.remove(r)}}}hideBone(i){const o=this.boneMap.get(i);o&&(o.visible=!1)}showBone(i){const o=this.boneMap.get(i);o&&(o.visible=!0)}get bones(){return[...this.boneMap.keys()]}dispose(){this.animator.dispose()}loadTexture(i){return new Promise((o,e)=>{new n.TextureLoader().load(i,a=>{o(a)})})}}class Pe{constructor(i,o,e,s){this.canvasElement=i,this.texturePath=e,this.options=s,this.renderingRequested=!1,this.renderer=new n.WebGLRenderer({canvas:i,alpha:s.alpha??!1,antialias:s.antialias??!1}),this.renderer.setPixelRatio(window.devicePixelRatio),this.camera=new n.PerspectiveCamera(70,2,.1,1e3),this.camera.position.x=-20,this.camera.position.y=20,this.camera.position.z=-20,this.camera.updateProjectionMatrix(),this.controls=new ge(this.camera,i),this.scene=new n.Scene,this.scene.add(new n.AmbientLight(16777215)),s.alpha&&(this.scene.background=new n.Color(13299960)),this.model=new W(o,e),this.scene.add(this.model.getGroup()),window.addEventListener("resize",this.onResize.bind(this)),this.controls.addEventListener("change",()=>this.requestRendering()),this.onResize(),this.loadedModel=this.loadModel().then(()=>this.requestRendering())}async loadModel(){await this.model.create()}get width(){return this.options.width??window.innerWidth}get height(){return this.options.height??window.innerHeight}render(i=!0){var o;this.controls.update(),this.renderer.render(this.scene,this.camera),this.renderingRequested=!1,i&&this.model.shouldTick&&(this.model.tick(),(o=this.model.animator.winterskyScene)==null||o.updateFacingRotation(this.camera),this.requestRendering())}requestRendering(i=!1){if(i)return this.render(!1);this.renderingRequested||(this.renderingRequested=!0,requestAnimationFrame(()=>this.render()))}onResize(){this.renderer.setSize(this.width,this.height,!0),this.camera.aspect=this.width/this.height,this.positionCamera(),this.requestRendering()}dispose(){window.removeEventListener("resize",this.onResize),this.controls.removeEventListener("change",this.requestRendering)}addHelpers(){this.scene.add(new n.AxesHelper(50)),this.scene.add(new n.GridHelper(20,20)),this.scene.add(new n.BoxHelper(this.model.getGroup(),16776960)),this.requestRendering()}getModel(){return this.model}positionCamera(i=1.5,o=!0){o&&this.model.getGroup().rotation.set(0,Math.PI,0);const e=new n.Box3().setFromObject(this.model.getGroup()).getBoundingSphere(new n.Sphere),s=this.camera.fov*Math.PI/180*i,a=e.radius/Math.tan(s/2),g=Math.sqrt(Math.pow(a,2)+Math.pow(a,2));this.camera.position.set(g,g,g),this.controls.update(),this.camera.lookAt(e.center),this.controls.target.set(e.center.x,e.center.y,e.center.z),this.camera.updateProjectionMatrix()}}R.Model=W,R.StandaloneModelViewer=Pe,Object.defineProperty(R,Symbol.toStringTag,{value:"Module"})});
